<!-- reset-password.html -->
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Đặt lại mật khẩu</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#f7f7f8; }
    .wrap { max-width: 420px; margin: 6vh auto; background: #fff; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.06); padding: 24px; }
    h1 { margin: 0 0 8px; font-size: 20px; }
    p  { color:#555; }
    .row { margin-top: 16px; }
    label { display:block; font-size: 14px; margin-bottom: 8px; color:#333; }
    input[type=password] {
      width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; font-size:16px;
    }
    button {
      width:100%; margin-top:16px; padding:12px; border:0; border-radius:10px; font-size:16px;
      cursor:pointer; background:#111827; color:#fff;
    }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .alert { margin-top: 16px; padding:12px; border-radius:10px; font-size:14px; }
    .alert.error { background:#fff1f2; color:#b91c1c; border:1px solid #fecaca; }
    .alert.ok    { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .muted { font-size:12px; color:#666; margin-top:12px; text-align:center; }
    .loading { opacity:.8; }
    .foot { margin-top:18px; text-align:center; }
    a { color:#2563eb; text-decoration:none; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <h1>Đặt lại mật khẩu</h1>
    <p id="intro">Nhập mật khẩu mới cho tài khoản của bạn.</p>

    <div id="alert" class="alert" style="display:none"></div>

    <form id="form" class="row" autocomplete="off">
      <label for="pw1">Mật khẩu mới</label>
      <input id="pw1" type="password" minlength="8" required placeholder="••••••••" />
      <label for="pw2" style="margin-top:12px;">Nhập lại mật khẩu mới</label>
      <input id="pw2" type="password" minlength="8" required placeholder="••••••••" />
      <button id="btn" type="submit">Cập nhật mật khẩu</button>
    </form>

    <p class="muted" id="meta"></p>
    <div class="foot">
      <a href="./index.html">Về trang đăng nhập</a>
    </div>
  </div>

  <script>
    // ====== CẤU HÌNH (điền dự án của bạn) ======
    const SUPABASE_URL = 'https://uojhzjbsfwsgxbnxusar.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamh6amJzZndzZ3hibnh1c2FyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNzM3OTMsImV4cCI6MjA3MDY0OTc5M30.Zq0_EnshfRWqO430e7gKAuvh8MzBm8JFeqSpjy0BNiQ';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $alert = document.getElementById('alert');
    const $form  = document.getElementById('form');
    const $btn   = document.getElementById('btn');
    const $meta  = document.getElementById('meta');

    function showAlert(type, msg) {
      $alert.className = 'alert ' + (type === 'error' ? 'error' : 'ok');
      $alert.textContent = msg;
      $alert.style.display = 'block';
    }
    function hideAlert(){ $alert.style.display='none'; }

    function parseHashParams() {
      const hash = window.location.hash.startsWith('#') ? window.location.hash.slice(1) : window.location.hash;
      const params = new URLSearchParams(hash);
      return {
        access_token: params.get('access_token'),
        refresh_token: params.get('refresh_token'),
        type: params.get('type'),
        expires_at: Number(params.get('expires_at') || '0'),
        expires_in: Number(params.get('expires_in') || '0'),
        token_type: params.get('token_type')
      };
    }

    async function bootstrap() {
      try {
        const { access_token, refresh_token, type, expires_at } = parseHashParams();

        if (!access_token || !refresh_token) {
          showAlert('error', 'Thiếu thông tin phiên khôi phục. Hãy mở lại link “Đặt lại mật khẩu” từ email.');
          $form.style.display = 'none';
          return;
        }
        if (type !== 'recovery') {
          showAlert('error', 'Link không hợp lệ (type khác recovery). Hãy dùng đúng link “Đặt lại mật khẩu”.');
          $form.style.display = 'none';
          return;
        }
        if (expires_at && Date.now()/1000 > expires_at) {
          showAlert('error', 'Link đã hết hạn. Vui lòng yêu cầu đặt lại mật khẩu mới.');
          $form.style.display = 'none';
          return;
        }

        // Thiết lập session tạm bằng token trong hash
        const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
        if (error) {
          showAlert('error', 'Không thể thiết lập phiên. ' + error.message);
          $form.style.display = 'none';
          return;
        }

        const { data: { user } } = await supabase.auth.getUser();
        if (user?.email) {
          $meta.textContent = 'Khôi phục cho: ' + user.email;
        }
      } catch (e) {
        showAlert('error', 'Lỗi khởi tạo: ' + (e?.message || e));
        $form.style.display = 'none';
      }
    }

    $form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideAlert();

      const pw1 = document.getElementById('pw1').value;
      const pw2 = document.getElementById('pw2').value;
      if (pw1 !== pw2) {
        showAlert('error', 'Hai mật khẩu không trùng nhau.');
        return;
      }
      if (pw1.length < 8) {
        showAlert('error', 'Mật khẩu phải tối thiểu 8 ký tự.');
        return;
      }

      $btn.disabled = true;
      $btn.textContent = 'Đang cập nhật...';
      document.body.classList.add('loading');

      // Cập nhật mật khẩu
      const { error } = await supabase.auth.updateUser({ password: pw1 });
      if (error) {
        showAlert('error', 'Cập nhật mật khẩu thất bại: ' + error.message);
        $btn.disabled = false;
        $btn.textContent = 'Cập nhật mật khẩu';
        document.body.classList.remove('loading');
        return;
      }

      showAlert('ok', 'Đã cập nhật mật khẩu. Bạn sẽ được chuyển về trang đăng nhập...');
      // Xóa hash để tránh lộ token khi copy URL
      history.replaceState(null, '', window.location.pathname);
      // Đăng xuất rồi chuyển hướng
      setTimeout(async () => {
        await supabase.auth.signOut();
        window.location.href = './index.html';
      }, 1500);
    });

    bootstrap();
  </script>
</body>
</html>
